--TABELLA DEI CONTI

CREATE TABLE conto(
    --ID_CONTO identifica univocamente un conto
    id_conto INT PRIMARY KEY,
    --NOME_CONTO nome assegnato al conto
    nome_conto VARCHAR(256) NOT NULL,
    --IBAN iban realtivo al conto se presete
    iban VARCHAR(26),
    --SALDO saldo relativo al conto
    saldo DECIMAL NOT NULL DEFAULT 0.00,
    id_portafoglio INT NOT NULL,
    CONSTRAINT FK_id_portafoglio FOREIGN KEY(id_portafoglio)
        REFERENCES portafoglio(id_portafoglio)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT validate_iban
        CHECK (iban ~ '^IT[0-9]{2}[A-Z]{1}[0-9]{21}$')
);

--TRIGGER PER SETTARE IN AUTOMATICO LA CHIAVE PRIMARIA
CREATE OR REPLACE FUNCTION ContoPK()
    RETURNS TRIGGER
AS $$
DECLARE
    pk conto.id_conto%TYPE;
BEGIN
	SELECT MAX(id_conto) + 1 INTO pk FROM conto;
    IF(NEW.id_conto != pk)THEN
        NEW.id_conto := pk;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE TRIGGER ContoPK
BEFORE INSERT
ON conto
FOR EACH ROW
EXECUTE PROCEDURE ContoPK();

--INSERIMENTI DI ESEMPIO DELLA TABELLA CONTO

INSERT INTO conto VALUES(1, 'Contanti', NULL , 51.25, 1);
INSERT INTO conto VALUES(2, 'BBVA', 'IT29P8440115377743262655956', 1248.50, 1);
INSERT INTO conto VALUES(3, 'Hype', 'IT36B1690816578157590551079', 700.25, 1);
INSERT INTO conto VALUES(4, 'Contanti', NULL , 100.00, 2);
INSERT INTO conto VALUES(5, 'BBVA', 'IT38A2128392556003642900114', 4500.00, 2);
INSERT INTO conto VALUES(6, 'Hype Premium', 'IT04S8351927801180083641532', 400.00, 2);
INSERT INTO conto VALUES(7, 'Intesa San Paolo', 'IT45R6803462892261131810825' , 1000.00, 3);
INSERT INTO conto VALUES(8, 'BPER Business', 'IT53Q7513393390277705543243', 750.00, 3);
INSERT INTO conto VALUES(9, 'AMEX Platinum', 'IT52S6907808060854807743999', 750.00, 3);
 